{% extends "Base/base.html" %} {% load custom_tags %}
{% load humanize %}{% load static %}
{% block styles %}
    <style>
        .input-wrapper {
            position: relative;

        }
        .input-wrapper label {
            position: absolute;
            top: -0.6rem; /* push above border */
            left: 1.75rem;
            background: #FFFFFF; /* same as background to cover border */
            padding: 0 4px;
            font-size: 0.8rem;
            color: #aaa;
        }
        .nexticon {
            position: absolute;
            right: -20px;

            width: 20px;
            border-radius: 20px;
            color: #000000ff;
        }
        .previcon {
            position: absolute;
            left: -20px;

            width: 20px;
            border-radius: 20px;
            color: #000000ff;
        }

    </style>
{% endblock styles %}

{% block main_block %}
    <div class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="d-flex justify-content-between align-items-center mb-6">
                <h3 class="fw-bold mb-0">View Proforma Invoices</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card card-round">
                    <div class="card-header">
                        <div class="card-head-row card-tools-still-right">
                            <div class="card-title mb-6 mb-md-0">
                                View Proforma Invoices
                            </div>

                            <div class="card-tools">
                                <form method="get" action="" class="filter-form">
                                    <div class="row g-2 align-items-end">

                                        <div class="col-auto">
                                            <div class="input-group ">
                                                <span class="input-group-text">Start Date</span>
                                                <input type="date" name="start_date" id="start_date" class="form-control" value="{{ request.GET.start_date }}">
                                            </div>
                                        </div>
                                            <div class="col-auto">
                                                <div class="input-group ">
                                                    <span class="input-group-text">End Date</span>
                                                    <input type="date" name="end_date" id="end_date" class="form-control" value="{{ request.GET.end_date }}">
                                                </div>
                                            </div>

                                        <!-- Party Name -->
                                        <div class="col-12 col-md-3">
                                            <div class="col-auto">
                                                <select name="party_id" id="party_filter" class="form-select form-control" >
                                                    <option value="">Select Parties</option>
                                                    {% for party in party_name %}
                                                        <option value="{{ party.party_name }}"
                                                            {% if request.GET.select_company == party.party_name %}selected{% endif %}>
                                                            {{ party.party_name }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Buttons -->
                                        <div class="col-12 col-md-2 d-flex gap-2">
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="fa fa-search"></i>
                                            </button>
                                            <a href="{{ request.path }}" class="btn btn-secondary w-100">
                                                Reset
                                            </a>
                                        </div>

                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="thead-light">
                                    <tr class="text-nowrap text-center">
                                        <th scope="col" class="sticky-left">
                                            Sr No
                                        </th>
                                        <th scope="col">
                                            Invoices no.
                                        </th>
                                        <th scope="col">
                                            <a href="?invoice_date_sorting={% if request.GET.invoice_date_sorting == 'asc' %}desc{% else %}asc{% endif %}">Invoice Date</a>
                                        </th>
                                        <th scope="col">Mode / Payment</th>
                                        <th scope="col">
                                            <a href="?company_name_sorting={% if request.GET.company_name_sorting == 'asc' %}desc{% else %}asc{% endif %}">Party Name </a>
                                        </th>
                                        <th scope="col">Party Contact</th>
                                        <th scope="col">Party Email</th>
                                        <th scope="col">Billing Address</th>
                                        <th scope="col">Billing GSTINT No</th>
                                        <th scope="col">Billing State Name</th>
                                        <th scope="col">title</th>
                                        <th scope="col">Job Name</th>
                                        <th scope="col">Pouch Open Size</th>
                                        <th scope="col">Cylinder Size</th>
                                        <th scope="col">Quantity</th>
                                        <th scope="col">PRPC Rate</th>
                                        <th scope="col">Taxable Value</th>
                                        <th scope="col">GST</th>
                                        <th scope="col">Total Taxable Value</th>
                                        <th scope="col">Gst Value</th>
                                        <th scope="col">Total Amount</th>
                                        <th scope="col">Proforma Statues</th>
                                        <th scope="col"  class="sticky-right" colspan="2">Actions</th>
                                    </tr>
                                </thead>
                                
                                {% if proformaInvoices %}
                                <tbody>
                                    {% for proforma in proformaInvoices %}

                                        <tr class="text-nowrap text-center ">
                                            <td
                                                data-bs-toggle="modal"
                                                data-bs-target="#viewModal{{ proforma.id }}" class="sticky-left">
                                                {{ forloop.counter}}
                                            </td>
                                            <td>{{ proforma.invoice_no }}</td>
                                            <td>{{ proforma.invoice_date }}</td>
                                            <td>{{ proforma.mode_payment }}</td>

                                            <td>{{ proforma.party_details.party_name }}</td>
                                            <td>{{ proforma.party_contact_used.party_number  }}</td>
                                            <td>{{ proforma.party_email_used.email }}</td>
                                            <td data-bs-toggle="modal" data-bs-target="#billing_addressModel{{proforma.id}}" title="{{proforma.id}}"  class="text-truncate">{{  proforma.party_billing_address_used.billing_address |truncatechars:30 }}</td>
                                            <td>{{ proforma.billing_gstin_no }}</td>
                                
                                            <td>{{ proforma.billing_state_name }}</td>
                                            <td>
                                                {% for job in proforma.job_details.all %}
                                                    <div>{{ job.title }}</div>
                                                {% endfor %}
                                            </td>


                                            <td>
                                                {% for job in proforma.job_details.all %}
                                                    <div>{{ job.job_name }}</div>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                {% for job in proforma.job_details.all %}
                                                    <div>{{ job.pouch_open_size }}</div>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                {% for job in proforma.job_details.all %}
                                                    <div>{{ job.cylinder_size }}</div>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                {% for job in proforma.job_details.all %}
                                                    <div>{{ job.quantity }}</div>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                {% for job in proforma.job_details.all %}
                                                    <div>{{ job.prpc_rate|indian_currency_format }}</div>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                {% for job in proforma.job_details.all %}
                                                    <div>{{ job.taxable_value|indian_currency_format }}</div>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                {% for gst in proforma.gst %}
                                                    <span>{{ gst }}  &nbsp; </span>
                                                {% endfor %}
                                            </td>

                                            <td> {{proforma.total_taxable_value|indian_currency_format }} </td>
                                            <td> {{proforma.gst_value|indian_currency_format }} </td>
                                            <td>{{ proforma.total|indian_currency_format }}</td>

                                            <td>
                                                {% if proforma.invoice_status == "Pending" %}
                                                    <span class="badge bg-danger text-white">Pending</span>
                                                {% elif proforma.invoice_status == "Confirmed" %}
                                                    <span class="badge bg-success">Confirmed</span>

                                                {% else %}
                                                    <span class="badge bg-secondary">{{ proforma.invoice_status }}</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-truncate sticky-right" colspan="3">
                                                <form action="{% url 'delete_proforma_invoice' proforma_id=proforma.id %}" method="POST" class="d-inline" id="delete-form-{{ proforma.id }}">
                                                    {% csrf_token %}
                                                    <button
                                                        type="button"
                                                        name="delete_proforma_invoice"
                                                        class="btn  btn-outline-danger"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#confirmationModal"
                                                        data-id="{{ proforma.id }}"
                                                    >
                                                        <i class="fa fa-trash" aria-hidden="true"></i>
                                                    </button>
                                                </form>

                                                <button
                                                    type="button"
                                                    class="btn  btn-outline-success mx-2"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#proformaemailModal{{ proforma.id }}"
                                                >
                                                    <i class="fa fa-envelope" aria-hidden="true"></i>
                                                </button>
                                                <form action="{% url 'view_proforma_invoice' %}" method="POST" class="d-inline">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="proforma_id" value="{{ proforma.id }}">
                                                <button
                                                    type="submit"
                                                    class="btn  btn-outline-success mx-2"
                                                    name="print_proforma_invoice"
                                                    formtarget="_blank"
                                                >
                                                    <i class="fa fa-print" aria-hidden="true"></i>
                                                </button>
                                            </form>
                                            </td>



                                        <!-- Modal -->
                                            <div class="modal fade" id="confirmationModal" tabindex="-1"aria-labelledby="confirmationModalLabel" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5
                                                                class="modal-title"
                                                                id="confirmationModalLabel"
                                                            >
                                                                Confirm Deletion
                                                            </h5>
                                                            <button
                                                                type="button"
                                                                class="btn-close"
                                                                data-bs-dismiss="modal"
                                                                aria-label="Close"
                                                            ></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            Are you sure you want to
                                                            delete this item?
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button
                                                                type="button"
                                                                class="btn btn-danger"
                                                                onclick="submitForm()"
                                                            >
                                                                Yes
                                                            </button>
                                                            <button type="button"
                                                                    class="btn btn-secondary"
                                                                    data-bs-dismiss="modal">
                                                                No
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {% include 'Includes/proforma/view.html' %}
                                            <!-- Corrections Modal -->
                                            {% include 'Includes/proforma/correction.html' %}
                                            


                                            <!-- Email Modal -->
                                            {% include 'Includes/proforma/send_mail.html' %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                {% else %}
                                  
                                  <tr>
                                    <td colspan="24" class="text-left">No data available</td>
                                  </tr>
                                {% endif %}
                                  
                            </table>

                        </div>
                        
                    </div>
                </div>
            </div>
            {% include 'Includes/proforma/navbar.html' %}
        </div>
    </div>
{% endblock main_block %}



{% block script %}
    <script>
        function formatNumberWithCommas(input) {
            let value = input.value;

            value = value.replace(/,/g, "");

            value = value.replace(/[^0-9.]/g, "");

            const parts = value.split(".");
            if (parts.length > 2) {
                value = parts[0] + "." + parts.slice(1).join("");
            }

            if (value === "") {
                input.value = "";
                return;
            }

            if (value === ".") {
                input.value = ".";
                return;
            }

            const [integerPart, decimalPart] = value.split(".");

            if (!integerPart) {
                input.value = decimalPart !== undefined ? "." + decimalPart : "";
                return;
            }

            const formattedInteger = parseInt(integerPart).toLocaleString("en-IN");

            if (decimalPart !== undefined) {
                input.value = formattedInteger + "." + decimalPart;
            } else {
                input.value = formattedInteger;
            }
        }
    </script>

    {% comment %} <script src="{% static 'js/proforma_view.js' %}"></script> {% endcomment %}

    <script>
        let formIdToSubmit;
        document.addEventListener(
            "DOMContentLoaded",
            function () {
                const deleteButtons =
                    document.querySelectorAll(
                        ".btn-outline-danger"
                    );
                deleteButtons.forEach(
                    (button) => {
                        button.addEventListener(
                            "click",
                            function () {
                                formIdToSubmit =
                                    this
                                    .dataset
                                    .id;
                            }
                        );
                    }
                );
            }
        );
        function submitForm() {
            document
                .getElementById(
                    "delete-form-" +
                    formIdToSubmit
                )
                .submit();
        }
    </script>

{% endblock script %}
