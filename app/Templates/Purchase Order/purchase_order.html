{% extends "Base/base.html" %}
{% load custom_tags %}
{% load static %}


{% block main_block %}
    <div class="page-inner">
            <div
                class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4" >
                <div>
                    <h3 class="fw-bold mb-3">Purchase Order</h3>
                </div>
            </div>
            {% include "Includes/purchase_order/form.html" %}
 


    </div>
{% endblock %}
{% block script %}
<script>
    const pouchRateAjaxUrl = "{% url 'purchase_order_ajax' %}";
</script>
    <script src="{% static 'js/ajax/purchase_order.js' %}"></script>
    <script src="{% static 'js/purchase_order.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {

    document.addEventListener("click", function (e) {

        /* ===============================
           ADD JOB
        =============================== */
        const addBtn = e.target.closest("#add-job, #add-jobs");
        if (addBtn) {

            // CASE 1: EXISTING DATA
            const dataBlocks = document.querySelectorAll(".job-block_data");
            if (dataBlocks.length) {
                const container = document.getElementById("job_data_container");
                const clone = dataBlocks[dataBlocks.length - 1].cloneNode(true);
                resetJobBlock(clone);
                container.appendChild(clone);
                return;
            }

            // CASE 2: NORMAL
            const normalBlocks = document.querySelectorAll(".job-block");
            if (!normalBlocks.length) return;

            const container = document.getElementById("jobs-container");
            const clone = normalBlocks[normalBlocks.length - 1].cloneNode(true);
            resetJobBlock(clone);
            container.appendChild(clone);
            return;
        }

        /* ===============================
           REMOVE JOB
        =============================== */
        const removeBtn = e.target.closest(".remove-job");
        if (removeBtn) {
            const blocks = document.querySelectorAll(".job-block, .job-block_data");
            if (blocks.length === 1) {
                alert("At least one job is required");
                return;
            }
            removeBtn.closest(".job-block, .job-block_data").remove();
        }
    });

    /* ===============================
       JOB NAME â†’ OTHERS
    =============================== */
    document.addEventListener("change", function (e) {
        if (!e.target.classList.contains("job_name")) return;

        const block = e.target.closest(".job-block, .job-block_data");
        const newInput = block.querySelector(".new_job_name");
        if (!newInput) return;

        if (e.target.value === "others") {
            newInput.classList.remove("d-none");
            newInput.required = true;
            newInput.focus();
        } else {
            newInput.classList.add("d-none");
            newInput.required = false;
            newInput.value = "";
        }
    });

    /* ===============================
       FORM SUBMIT
    =============================== */
    const form = document.querySelector("form");
    if (form) {
        form.addEventListener("submit", function (e) {

            let valid = true;
            const jobsToProcess = [];

            document.querySelectorAll(".job-block").forEach(block => {
                const select = block.querySelector(".job_name");
                const input = block.querySelector(".new_job_name");

                if (select && select.value === "others") {
                    const val = input.value.trim();
                    if (!val) {
                        alert("Please enter Job Name for Others");
                        input.focus();
                        valid = false;
                        return;
                    }
                    jobsToProcess.push({ select, input, val });
                }
            });

            if (!valid) {
                e.preventDefault();
                return;
            }

            jobsToProcess.forEach(({ select, input, val }) => {
                const option = new Option(val, val, true, true);
                select.appendChild(option);
                select.value = val;
                input.disabled = true;
            });
        });
    }

    /* ===============================
       RESET FUNCTION
    =============================== */
    function resetJobBlock(block) {
        block.querySelectorAll("input, textarea, select").forEach(el => {
            if (el.type !== "hidden") el.value = "";
            el.disabled = false;
            el.readOnly = false;
            el.required = false;
            if (el.tagName === "SELECT") el.selectedIndex = 0;
        });

        const newJob = block.querySelector(".new_job_name");
        if (newJob) newJob.classList.add("d-none");
    }

});
</script>





{% endblock %}