{% extends 'base/base.html' %} {% load static %} {% block main_block %}
<div class="page-inner">
    <div
        class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4"
    >
        <div>
            <h3 class="fw-bold mb-3">Create Quotation</h3>
        </div>
    </div>
    {% include "Includes/quotation/form.html" %}
</div>

{% endblock main_block %} 

{% block script %}
<script src="{% static 'js/quotation.js' %}"></script>
<script src="{% static 'js/ajax/quotation.js' %}"></script>

<script>
    const pouchRateAjaxUrl = "{% url 'quotation_page_ajax' %}";
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const container = document.getElementById("jobs-container");
        const addBtn = document.getElementById("add-job");

        // ADD JOB
        addBtn.addEventListener("click", () => {
            const job = document.querySelector(".job-block");
            const clone = job.cloneNode(true);

            // Reset all inputs
            clone.querySelectorAll("input, textarea").forEach((el) => {
                el.value = "";
                el.disabled = false;
                el.required = false;
            });

            // Reset selects
            clone.querySelectorAll("select").forEach((sel) => {
                sel.selectedIndex = 0;
            });

            // Hide "new job name"
            const newJobInput = clone.querySelector(".new_job_name");
            if (newJobInput) {
                newJobInput.classList.add("d-none");
            }

            container.appendChild(clone);
        });

        // REMOVE JOB
        document.addEventListener("click", (e) => {
            if (e.target.classList.contains("remove-job")) {
                const jobs = document.querySelectorAll(".job-block");
                if (jobs.length === 1) {
                    alert("At least one job is required");
                    return;
                }
                e.target.closest(".job-block").remove();
            }
        });
    });
</script>

<script>
    document.addEventListener("change", function (e) {
        if (!e.target.classList.contains("job_name")) return;

        const block = e.target.closest(".job-block");
        const newInput = block.querySelector(".new_job_name");

        if (e.target.value === "others") {
            newInput.classList.remove("d-none");
            newInput.required = true;
            newInput.focus();
        } else {
            newInput.classList.add("d-none");
            newInput.required = false;
            newInput.value = "";
        }
    });
</script>

<script>
    document.querySelector("form").addEventListener("submit", function (e) {
        let valid = true;

        document.querySelectorAll(".job-block").forEach((block) => {
            const select = block.querySelector(".job_name");
            const input = block.querySelector(".new_job_name");

            if (select.value === "others") {
                const val = input.value.trim();

                if (!val) {
                    alert("Please enter Job Name for Others");
                    input.focus();
                    valid = false;
                    return;
                }


                const option = new Option(val, val, true, true);
                select.appendChild(option);
                select.value = val;

                input.disabled = true;
            }
        });

        if (!valid) e.preventDefault();
    });
</script>

{% endblock script %}
