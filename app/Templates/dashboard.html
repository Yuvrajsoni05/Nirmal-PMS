{% extends "Base/base.html" %}
{% load custom_tags %}
{% load humanize %}
{% load static %}
{% block styles %}
    <style>
        .nexticon {
            position: absolute;
            right: -20px;

            width: 20px;
            border-radius: 20px;
            color: #000000ff;
        }
        .previcon {
            position: absolute;
            left: -20px;

            width: 20px;
            border-radius: 20px;
            color: #000000ff;
        }

    </style>
{% endblock styles %}
{% block title %}Dashboard{% endblock %}
{% block main_block %}
    <div class="page-inner">
        <!-- Header Section -->
        <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
            <div class="page-title">
                <h2 class="fw-bold mb-3">
                    Welcome Back  {{ user.first_name }} {{ user.last_name }} !

                </h2>
            </div>
            <div class="page-actions ms-md-auto py-2 py-md-0">
                <a href="{% url "job_entry" %}" class="btn btn-primary btn-round">Add New Job</a>
            </div>
        </div>
        <!-- Statistics Cards Section -->
        <section class="stats-section">
            <div class="row">
                <div class="col-sm-6 col-md-3">
                    <div class="card card-stats card-round">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col col-stats ms-3 ms-sm-0">
                                    <div class="numbers">
                                        <p class="card-category">Total Active Job</p>
                                        <h2 class="card-title">{{ total_active_job }}</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-md-3">
                    <div class="card card-stats card-round">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col col-stats ms-3 ms-sm-0">
                                    <div class="numbers">
                                        <p class="card-category">Total Party</p>
                                        <h4 class="card-title">{{ count_of_company }}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-md-3">
                    <div class="card card-stats card-round">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col col-stats ms-3 ms-sm-0">
                                    <div class="numbers">
                                        <p class="card-category">Total Cylinder Company</p>
                                        <h4 class="card-title">{{ count_of_cylinder_company }}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-md-3">
                    <div class="card card-stats card-round">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col col-stats ms-3 ms-sm-0">
                                    <div class="numbers">
                                        <p class="card-category">Total Job</p>
                                        <h4 class="card-title">{{ total_job }}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Job Details Table Section -->
        <section class="job-details-section">
            <div class="row">
                <div class="col-md-12">
                    <div class="card card-round">
                        <div class="card-header">
                            <div class="card-head-row card-tools-still-right">
                                <div class="card-title">Job Details</div>

                                <div class="card-tools">
                                    <form method="get"
                                          action="{% url 'dashboard_page' %}"
                                          class="d-flex flex-wrap align-items-end gap-2">

                                        <!-- Start Date -->
                                        <div class="col-12 col-md-auto">
                                            <label for="date" class="form-label mb-1 fw-bold">Start Date</label>
                                            <input type="date"
                                                   class="form-control"
                                                   id="start_date"
                                                   name="start_date"
                                                   placeholder="Start Date"
                                                   value="{{ request.GET.start_date|default_if_none:'' }}">
                                        </div>

                                        <!-- End Date -->
                                        <div class="col-12 col-md-auto">
                                            <label for="end_date" class="form-label mb-1 fw-bold">End Date</label>
                                            <input type="date"
                                                   class="form-control"
                                                   id="end_date"
                                                   name="end_date"
                                                   placeholder="End Date"
                                                   value="{{ request.GET.end_date|default_if_none:'' }}">
                                        </div>

                                        <!-- Company Name -->
                                        <div class="col-12 col-md-auto" style="min-width: 220px;">
                                            <label for="party_name" class="form-label mb-1 fw-bold">Party name Search</label>
                                            <select class="form-select form-control"
                                                    name="party_name"
                                                    id="party_name">
                                                {% if request.GET.party_name %}
                                                    <!-- Show the selected value as first option -->
                                                    <option value="{{ request.GET.party_name }}">{{ request.GET.party_name }}</option>

                                                {% else %}
                                                    <option value="">Select Party Name</option>
                                                {% endif %}

                                                {% for party in party_names %}
                                                    {% if party.party_name != request.GET.party_name %}
                                                        <option value="{{ party.party_name }}">
                                                            {{ party.party_name }}
                                                        </option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Job Name -->
                                        <div class="col-12 col-md-auto" style="min-width: 220px;">
                                            <label for="job_name_search" class="form-label mb-1 fw-bold">Job Name</label>
                                            <select class="form-select form-control"
                                                    name="job_name_search"
                                                    id="job_name_search">
                                                {% if request.GET.job_name_search %}
                                                    <!-- Show the selected value as first option -->
                                                    <option value="{{ request.GET.job_name_search }}">
                                                        {{ request.GET.job_name_search }}
                                                    </option>

                                                {% else %}
                                                    <option value="">Select Job Name</option>
                                                {% endif %}

                                                {% for job in job_names %}
                                                    {% if job.job_name != request.GET.job_name_search %}
                                                        <option value="{{ job.job_name }}">
                                                            {{ job.job_name }}
                                                        </option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <!-- Search Button -->
                                        <div class="col-12 col-md-auto">
                                            <button type="submit"
                                                    class="btn btn-primary w-100 w-md-auto"
                                                    data-mdb-ripple-init>
                                                <i class="fa fa-search me-1"></i> Search
                                            </button>
                                        </div>

                                        <!-- Reset Button -->
                                        <div class="col-12 col-md-auto">
                                            <a href="{% url 'dashboard_page' %}" class="btn btn-secondary w-100 w-md-auto">
                                                Reset
                                            </a>

                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Table Content -->
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table align-items-center table-striped">
                                    <thead class="thead-light">
                                        <tr class="text-nowrap text-start">
                                            <th scope="col" class="sticky-left">
                                                <a href="?sorting={% if request.GET.sorting == 'asc' %}desc{% else %}asc{% endif %}&q={{ request.GET.party_name }}&date={{ request.GET.date }}&page={{ request.GET.page }}">Sr No</a>
                                            </th>
                                            <th scope="col">
                                                <a href="?date_sorting={% if request.GET.date_sorting == 'asc' %}desc{% else %}asc{% endif %}&q={{ request.GET.party_name }}&date={{ request.GET.date }}&page={{ request.GET.page }}">Date</a>
                                            </th>
                                            <th scope="col">Bill No</th>
                                            <th scope="col">
                                                <a href="?job_name_sorting={% if request.GET.job_name_sorting == 'asc' %}desc{% else %}asc{% endif %}&q={{ request.GET.party_name }}&date={{ request.GET.date }}&page={{ request.GET.page }}">Job Name</a>
                                            </th>
                                            <th scope="col">Job Type</th>
                                            <th scope="col">
                                                <a href="?party_name_sorting={% if request.GET.party_name_sorting == 'asc' %}desc{% else %}asc{% endif %}&q={{ request.GET.party_name }}&date={{ request.GET.date }}&page={{ request.GET.page }}">Party Name</a>
                                            </th>
                                            <th scope="col">Noc(No of Colors)</th>
                                            <th scope="col">Rate/Cylinder Purchase</th>
                                            <th scope="col">Rate/Cylinder sales</th>
                                            <th scope="col">Cylinder Size</th>
                                            <th scope="col">
                                                <a href="?cylinder_made_in_sorting={% if request.GET.cylinder_made_in_sorting == 'asc' %}desc{% else %}asc{% endif %}&q={{ request.GET.party_name }}&date={{ request.GET.date }}&page={{ request.GET.page }}">Cylinder Made In</a>
                                            </th>
                                            <th scope="col">Cylinder Bill No</th>
                                            <th scope="col">
                                                <a href="?cylinder_date_sorting={% if request.GET.cylinder_date_sorting == 'asc' %}desc{% else %}asc{% endif %}&q={{ request.GET.party_name }}&date={{ request.GET.date }}&page={{ request.GET.page }}">Cylinder Date</a>
                                            </th>
                                            <th scope="col">Pouch Size</th>
                                            <th scope="col">Open Size</th>
                                            <th scope="col">Combination</th>
                                            <th scope="col">Correction</th>
                                            <th scope="col">Images </th>
                                            <th scope="col" class="sticky-right">Job Status</th>
                                            <th scope="col">CDR Links</th>
                                            <th scope="col"> Job History </th>
                                            <th scope="col" class="sticky-right" colspan="3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if jobrecoreds %}
                                            {% for i in jobrecoreds %}

                                                <tr class="text-start">
                                                    <td class="text-truncate sticky-left"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#viewModal{{ i.id }}"> 
                                                        {{ forloop.counter }}  
                                                    </td>
                                                    <td class="text-truncate">{{ i.date }}</td>
                                                    <td class="text-truncate">{{ i.bill_no }}</td>
                                                    <td class="text-truncate">{{ i.job_name }}</td>
                                                    <td class="text-truncate">{{ i.job_type }}</td>
                                                    <td class="text-truncate">{{ i.party_details.party_name }}</td>
                                                    <td class="text-truncate">{{ i.noc }}</td>
                                                    <td class="text-truncate">₹ {{ i.prpc_purchase|indian_currency_format }}</td>
                                                    <td class="text-truncate">₹ {{ i.prpc_sell|indian_currency_format }}</td>
                                                    <td class="text-truncate">{{ i.cylinder_size }}</td>
                                                    <td class="text-truncate">{{ i.cylinder_made_in }}</td>
                                                    <td class="text-truncate">{{ i.cylinder_bill_no }}</td>
                                                    <td class="text-truncate">{{ i.cylinder_date }}</td>
                                                    <td class="text-truncate">{{ i.pouch_size }}</td>
                                                    <td class="text-truncate">{{ i.pouch_open_size }}</td>
                                                    <td class="text-truncate">{{ i.pouch_combination }}</td>
                                                    <!-- Correction Column -->
                                                    {% if i.correction %}
                                                        <td class="text-truncate"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#staticBackdrop{{ i.id }}"
                                                            title="{{ i.correction }}">
                                                            {{ i.correction|truncatechars:20 }}
                                                        </td>
                                                    {% else %}
                                                        <td class="text-truncate">
                                                            <span class="fw-bold">-</span>
                                                        </td>
                                                    {% endif %}
                                                    <!-- Folder/Images Column -->
                                                    <td class="text-truncate">
                                                        <div id="carousel-{{ i.id }}"
                                                             class="carousel slide"
                                                             data-bs-ride="carousel">
                                                            <div class="carousel-inner">
                                                                {% for job_image in i.image.all %}
                                                                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                                                        <div class="d-flex justify-content-center align-items-center"
                                                                             style="height: 50px">
                                                                            <a class="icon-link" href="{{ job_image.image.url }}" target="_blank">{{ job_image.image.name|filename }}</a>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                            <button class="carousel-control-prev"
                                                                    type="button"
                                                                    data-bs-target="#carousel-{{ i.id }}"
                                                                    data-bs-slide="prev">
                                                                <span class="previcon" aria-hidden="false">
                                                                    <i class="fa fa-caret-left" aria-hidden="true"></i>
                                                                </span>
                                                            </button>
                                                            <button class="carousel-control-next"
                                                                    type="button"
                                                                    data-bs-target="#carousel-{{ i.id }}"
                                                                    data-bs-slide="next">
                                                                <span class="nexticon" aria-hidden="true">
                                                                    <i class="fa fa-caret-right" aria-hidden="true"></i>
                                                                </span>
                                                            </button>
                                                        </div>
                                                    </td>

                                                    <!-- Job Status Column -->
                                                    <td class="text-truncate sticky-right">
                                                        {% if i.job_status == 'In Progress' %}
                                                            <span class="badge bg-success text-white">
                                                                {{ i.job_status }}
                                                            </span>
                                                        {% else %}
                                                            <span class="badge bg-danger text-white">
                                                                {{ i.job_status }}
                                                            </span>
                                                        {% endif %}
                                                    </td>
                                                    <!-- CDR Links Column -->
                                                    <td class="text-truncate">
                                                        {% if i.cdr_file_url %}
                                                            <a class="icon-link" href="{{ i.cdr_file_url }}" target="_blank">CDR</a>
                                                        {% else %}
                                                            {% if i.cdr_images_urls %}
                                                                <div id="cdr-carousel-{{ i.id }}" class="carousel slide" data-bs-ride="carousel">
                                                                    <div class="carousel-inner">
                                                                        {% for cdr_img in i.cdr_images_urls %}
                                                                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                                                                <div class="d-flex justify-content-center align-items-center" style="height: 50px;">
                                                                                    <a class="icon-link text-decoration-none "
                                                                                       href="{{ cdr_img }}" target="_blank">
                                                                                            {% comment %} {{ cdr_img|filename }} {% endcomment %} CDR
                                                                                    </a>
                                                                                </div>
                                                                            </div>
                                                                        {% endfor %}
                                                                    </div>

                                                                    <button class="carousel-control-prev" type="button"
                                                                            data-bs-target="#cdr-carousel-{{ i.id }}" data-bs-slide="prev">
                                                                        <span class="previcon" aria-hidden="false">
                                                                            <i class="fa fa-caret-left" aria-hidden="true"></i>
                                                                        </span>
                                                                    </button>

                                                                    <button class="carousel-control-next" type="button"
                                                                            data-bs-target="#cdr-carousel-{{ i.id }}" data-bs-slide="next">
                                                                        <span class="nexticon" aria-hidden="true">
                                                                            <i class="fa fa-caret-right" aria-hidden="true"></i>
                                                                        </span>
                                                                    </button>
                                                                </div>
                                                            {% else %}
                                                                <p>-</p>
                                                            {% endif %}
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-truncate"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#OldBackdrop{{ i.id }}"
                                                        title="{{ i.id }}">
                                                        {{ i.job_history.count }} Records
                                                    </td>

                                                    <!-- Actions Column -->
                                                    <td class="text-truncate sticky-right">
                                                        <div class="action-buttons">
                                                                <!-- Delete Button -->
                                                            <form method="post" action="{% url 'delete_data' delete_id=i.id %}" class="d-inline" id="delete-form-{{ i.id }}">
                                                                {% csrf_token %}
                                                                <button type="button"
                                                                        class="btn btn-outline-danger ms-1"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#confirmationModal"
                                                                        onclick="setFormId('{{ i.id }}')"><i class="fa fa-trash"></i></button>&nbsp;

                                                            </form>

                                                            <!-- Edit Button -->
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-primary"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#exampleModal{{ i.id }}">
                                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                                     width="16"
                                                                     height="16"
                                                                     fill="currentColor"
                                                                     class="bi bi-pencil-square"
                                                                     viewBox="0 0 16 16">
                                                                    <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z" />
                                                                    <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z" />
                                                                </svg>
                                                            </button>
                                                            <!-- Email Button -->
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-success"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#emailModal{{ i.id }}">
                                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                                     width="16"
                                                                     height="16"
                                                                     fill="currentColor"
                                                                     class="bi bi-envelope"
                                                                     viewBox="0 0 16 16">
                                                                    <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1zm13 2.383-4.708 2.825L15 11.105zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741M1 11.105l4.708-2.897L1 5.383z" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <!-- Modals for each row -->

                                                <!-- Modal Structure -->
                                            
                                                <!-- View Details Modal -->
                                                 {% include 'Includes/dashboard_page/view.html' %}
                                                    <!-- Email Modal -->
                                                 {% include 'Includes/dashboard_page/send_mail.html' %} 
                                                    <!-- Model Correction Job -->
                                                 {% include 'Includes/dashboard_page/correction.html' %} 
                                                    <!-- Edit Job -->
                                                 {% include 'Includes/dashboard_page/edit_job.html' %}
                                                    <!-- Model  Job History -->
                                                 {% include 'Includes/dashboard_page/job_history.html' %}
                                                       
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="20" class="text-center">No data available</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% include 'Includes/dashboard_page/navbar.html' %}

            </div>
        </div>
    </section>
        <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                                        <!-- Modal Header -->
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="confirmationModalLabel">Confirm Deletion</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                                        <!-- Modal Body -->
                                                            <div class="modal-body">
                                                                Are you sure you want to delete this item?
                                                            </div>
                                                                        <!-- Modal Footer -->
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-danger" onclick="submitForm()">Yes</button>
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

</div>
{% endblock main_block %}
{% block script %}
<script>
    let formIdToSubmit = null;

    function setFormId(id) {
        formIdToSubmit = id;
    }

    function submitForm() {
        if (!formIdToSubmit) {
            alert("Something went wrong. Please try again.");
            return;
        }

        document
            .getElementById("delete-form-" + formIdToSubmit)
            .submit();
    }
</script>


    <script src="{% static 'js/dashboard.js' %}"></script>
{% endblock script %}
