{% extends "Base/base.html" %} 
{% load humanize %} 
{% load static %} 
{% block style %} 
{% endblock style %} 
{% block main_block %}
<div class="page-inner">
    <div
        class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4" >
        <div>
            <h3 class="fw-bold mb-3">Create New job</h3>
        </div>
    </div>
    {% include 'Includes/job_entry/form.html' %}
</div>

{% endblock main_block %} {% block script %}


<script>
    const job_entryAjaxUrl = "{% url 'job_page_ajax' %}";
</script>


<script src="{% static 'js/ajax/job_entry.js' %}" ></script>
<script>
    $(document).ready(function () {
        function updateJobIndexes() {
            $("#job-details-section .job-section").each(function (idx) {
                $(this).attr("data-job-index", idx);

                // Update file input name
                $(this)
                    .find('input[type="file"]')
                    .attr("name", `files[${idx}][]`);
            });
        }

        $(document).on("click", "#add-job", function (e) {
            e.preventDefault();

            let newSection = $(
                "#job-details-section .job-section:first"
            ).clone();

            newSection.find("input").val("");
            newSection.find("select").prop("selectedIndex", 0);

            newSection.find(".close-job-btn").closest(".d-grid").remove();

            newSection.find("h5").after(`
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button class="btn btn-danger me-md-2 close-job-btn" type="button">X</button>
            </div>
        `);

            $("#job-details-section").append(newSection);
            updateJobIndexes();
        });

        $(document).on("click", ".close-job-btn", function (e) {
            e.preventDefault();
            if ($("#job-details-section .job-section").length > 1) {
                $(this).closest(".job-section").remove();
            }
        });
        updateJobIndexes();
    });
</script>

<script>
    document.addEventListener("input", function (e) {
        if (e.target.matches('select[name="job_name[]"]')) {
            const jobSelect = e.target;
            const block = jobSelect.closest("div");
            const newJobInput = block.querySelector(
                'input[name="new_job_name"]'
            );
            const hiddenField = block.querySelector(
                'input[name="job_name_real"]'
            );

            if (jobSelect.value === "others") {
                newJobInput.style.display = "block";
            } else {
                newJobInput.style.display = "none";
                newJobInput.value = "";
            }

            // Set value for backend
            hiddenField.value =
                jobSelect.value === "others"
                    ? newJobInput.value.trim()
                    : jobSelect.value;
        }

        if (e.target.matches('input[name="new_job_name"]')) {
            const newJobInput = e.target;
            const block = newJobInput.closest("div");
            const jobSelect = block.querySelector('select[name="job_name[]"]');
            const hiddenField = block.querySelector(
                'input[name="job_name_real"]'
            );

            // Update value for backend
            hiddenField.value = newJobInput.value.trim();
        }
    });
</script>
<script>
    document.addEventListener("input", function (e) {
        // 1) Handle select change
        if (e.target.matches('select[name="cylinder_made_in_select[]"]')) {
            const selectEl = e.target;
            const block = selectEl.closest(".col-12"); // or a closer wrapper
            const otherInput = block.querySelector(
                'input[name="cylinder_made_in_other[]"]'
            );
            const hiddenField = block.querySelector(
                'input[name="cylinder_made_in_real"]'
            );

            if (selectEl.value === "others") {
                otherInput.style.display = "block";
            } else {
                otherInput.style.display = "none";
                otherInput.value = "";
            }

            // Set value for backend
            hiddenField.value =
                selectEl.value === "others"
                    ? otherInput.value.trim()
                    : selectEl.value;
        }

        // 2) Handle typing in "Other" input
        if (e.target.matches('input[name="cylinder_made_in_other[]"]')) {
            const otherInput = e.target;
            const block = otherInput.closest(".col-12"); // same wrapper as above
            const hiddenField = block.querySelector(
                'input[name="cylinder_made_in_real"]'
            );

            hiddenField.value = otherInput.value.trim();
        }
    });
</script>

<script src="{% static 'js/job_entry.js' %}"></script>
{% endblock script %}
